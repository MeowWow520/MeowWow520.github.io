{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"import { LAppDelegate } from '@demo/lappdelegate.js'; import { LAppSubdelegate } from '@demo/lappsubdelegate.js'; import * as LAppDefine fro...","date":"2025-11-18T04:43:50.320Z","updated":"2025-11-18T04:43:50.320Z","comments":true,"path":"api/pages/live2d-widget/build/cubism5/index.js","covers":null,"content":"import { LAppDelegate } from '@demo/lappdelegate.js';\nimport { LAppSubdelegate } from '@demo/lappsubdelegate.js';\nimport * as LAppDefine from '@demo/lappdefine.js';\nimport { LAppModel } from '@demo/lappmodel.js';\nimport { LAppPal } from '@demo/lapppal';\nimport logger from '../logger.js';\nLAppPal.printMessage = () => { };\nclass AppSubdelegate extends LAppSubdelegate {\n    initialize(canvas) {\n        if (!this._glManager.initialize(canvas)) {\n            return false;\n        }\n        this._canvas = canvas;\n        if (LAppDefine.CanvasSize === 'auto') {\n            this.resizeCanvas();\n        }\n        else {\n            canvas.width = LAppDefine.CanvasSize.width;\n            canvas.height = LAppDefine.CanvasSize.height;\n        }\n        this._textureManager.setGlManager(this._glManager);\n        const gl = this._glManager.getGl();\n        if (!this._frameBuffer) {\n            this._frameBuffer = gl.getParameter(gl.FRAMEBUFFER_BINDING);\n        }\n        gl.enable(gl.BLEND);\n        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\n        this._view.initialize(this);\n        this._view._gear = {\n            render: () => { },\n            isHit: () => { },\n            release: () => { }\n        };\n        this._view._back = {\n            render: () => { },\n            release: () => { }\n        };\n        this._live2dManager._subdelegate = this;\n        this._resizeObserver = new window.ResizeObserver((entries, observer) => this.resizeObserverCallback.call(this, entries, observer));\n        this._resizeObserver.observe(this._canvas);\n        return true;\n    }\n    onResize() {\n        this.resizeCanvas();\n        this._view.initialize(this);\n    }\n    update() {\n        if (this._glManager.getGl().isContextLost()) {\n            return;\n        }\n        if (this._needResize) {\n            this.onResize();\n            this._needResize = false;\n        }\n        const gl = this._glManager.getGl();\n        gl.clearColor(0.0, 0.0, 0.0, 0.0);\n        gl.enable(gl.DEPTH_TEST);\n        gl.depthFunc(gl.LEQUAL);\n        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n        gl.clearDepth(1.0);\n        gl.enable(gl.BLEND);\n        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\n        this._view.render();\n    }\n}\nexport class AppDelegate extends LAppDelegate {\n    run() {\n        const loop = () => {\n            LAppPal.updateTime();\n            for (let i = 0; i < this._subdelegates.getSize(); i++) {\n                this._subdelegates.at(i).update();\n            }\n            this._drawFrameId = window.requestAnimationFrame(loop);\n        };\n        loop();\n    }\n    stop() {\n        if (this._drawFrameId) {\n            window.cancelAnimationFrame(this._drawFrameId);\n            this._drawFrameId = null;\n        }\n    }\n    release() {\n        this.stop();\n        this.releaseEventListener();\n        this._subdelegates.clear();\n        this._cubismOption = null;\n    }\n    transformOffset(e) {\n        const subdelegate = this._subdelegates.at(0);\n        const rect = subdelegate.getCanvas().getBoundingClientRect();\n        const localX = e.pageX - rect.left;\n        const localY = e.pageY - rect.top;\n        const posX = localX * window.devicePixelRatio;\n        const posY = localY * window.devicePixelRatio;\n        const x = subdelegate._view.transformViewX(posX);\n        const y = subdelegate._view.transformViewY(posY);\n        return {\n            x, y\n        };\n    }\n    onMouseMove(e) {\n        const lapplive2dmanager = this._subdelegates.at(0).getLive2DManager();\n        const { x, y } = this.transformOffset(e);\n        const model = lapplive2dmanager._models.at(0);\n        lapplive2dmanager.onDrag(x, y);\n        lapplive2dmanager.onTap(x, y);\n        if (model.hitTest(LAppDefine.HitAreaNameBody, x, y)) {\n            window.dispatchEvent(new Event('live2d:hoverbody'));\n        }\n    }\n    onMouseEnd(e) {\n        const lapplive2dmanager = this._subdelegates.at(0).getLive2DManager();\n        const { x, y } = this.transformOffset(e);\n        lapplive2dmanager.onDrag(0.0, 0.0);\n        lapplive2dmanager.onTap(x, y);\n    }\n    onTap(e) {\n        const lapplive2dmanager = this._subdelegates.at(0).getLive2DManager();\n        const { x, y } = this.transformOffset(e);\n        const model = lapplive2dmanager._models.at(0);\n        if (model.hitTest(LAppDefine.HitAreaNameBody, x, y)) {\n            window.dispatchEvent(new Event('live2d:tapbody'));\n        }\n    }\n    initializeEventListener() {\n        this.mouseMoveEventListener = this.onMouseMove.bind(this);\n        this.mouseEndedEventListener = this.onMouseEnd.bind(this);\n        this.tapEventListener = this.onTap.bind(this);\n        document.addEventListener('mousemove', this.mouseMoveEventListener, {\n            passive: true\n        });\n        document.addEventListener('mouseout', this.mouseEndedEventListener, {\n            passive: true\n        });\n        document.addEventListener('pointerdown', this.tapEventListener, {\n            passive: true\n        });\n    }\n    releaseEventListener() {\n        document.removeEventListener('mousemove', this.mouseMoveEventListener, {\n            passive: true\n        });\n        this.mouseMoveEventListener = null;\n        document.removeEventListener('mouseout', this.mouseEndedEventListener, {\n            passive: true\n        });\n        this.mouseEndedEventListener = null;\n        document.removeEventListener('pointerdown', this.tapEventListener, {\n            passive: true\n        });\n    }\n    initializeSubdelegates() {\n        this._canvases.prepareCapacity(LAppDefine.CanvasNum);\n        this._subdelegates.prepareCapacity(LAppDefine.CanvasNum);\n        const canvas = document.getElementById('live2d');\n        this._canvases.pushBack(canvas);\n        canvas.style.width = canvas.width;\n        canvas.style.height = canvas.height;\n        for (let i = 0; i < this._canvases.getSize(); i++) {\n            const subdelegate = new AppSubdelegate();\n            const result = subdelegate.initialize(this._canvases.at(i));\n            if (!result) {\n                logger.error('Failed to initialize AppSubdelegate');\n                return;\n            }\n            this._subdelegates.pushBack(subdelegate);\n        }\n        for (let i = 0; i < LAppDefine.CanvasNum; i++) {\n            if (this._subdelegates.at(i).isContextLost()) {\n                logger.error(`The context for Canvas at index ${i} was lost, possibly because the acquisition limit for WebGLRenderingContext was reached.`);\n            }\n        }\n    }\n    changeModel(modelSettingPath) {\n        const segments = modelSettingPath.split('/');\n        const modelJsonName = segments.pop();\n        const modelPath = segments.join('/') + '/';\n        const live2dManager = this._subdelegates.at(0).getLive2DManager();\n        live2dManager.releaseAllModel();\n        const instance = new LAppModel();\n        instance.setSubdelegate(live2dManager._subdelegate);\n        instance.loadAssets(modelPath, modelJsonName);\n        live2dManager._models.pushBack(instance);\n    }\n    get subdelegates() {\n        return this._subdelegates;\n    }\n}\n","count_time":{"symbolsCount":"7.1k","symbolsTime":"6 mins."},"toc":"","data":[]}