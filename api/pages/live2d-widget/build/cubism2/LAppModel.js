{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"import { L2DBaseModel, Live2DFramework, L2DEyeBlink } from './Live2DFramework.js'; import ModelSettingJson from './utils/ModelSettingJson.js...","date":"2025-11-18T04:43:50.315Z","updated":"2025-11-18T04:43:50.315Z","comments":true,"path":"api/pages/live2d-widget/build/cubism2/LAppModel.js","covers":null,"content":"import { L2DBaseModel, Live2DFramework, L2DEyeBlink } from './Live2DFramework.js';\nimport ModelSettingJson from './utils/ModelSettingJson.js';\nimport LAppDefine from './LAppDefine.js';\nimport MatrixStack from './utils/MatrixStack.js';\nimport logger from '../logger.js';\nclass LAppModel extends L2DBaseModel {\n    constructor() {\n        super();\n        this.modelHomeDir = '';\n        this.modelSetting = null;\n        this.tmpMatrix = [];\n    }\n    loadJSON(callback) {\n        const path = this.modelHomeDir + this.modelSetting.getModelFile();\n        this.loadModelData(path, model => {\n            for (let i = 0; i < this.modelSetting.getTextureNum(); i++) {\n                const texPaths = this.modelHomeDir + this.modelSetting.getTextureFile(i);\n                this.loadTexture(i, texPaths, () => {\n                    if (this.isTexLoaded) {\n                        if (this.modelSetting.getExpressionNum() > 0) {\n                            this.expressions = {};\n                            for (let j = 0; j < this.modelSetting.getExpressionNum(); j++) {\n                                const expName = this.modelSetting.getExpressionName(j);\n                                const expFilePath = this.modelHomeDir +\n                                    this.modelSetting.getExpressionFile(j);\n                                this.loadExpression(expName, expFilePath);\n                            }\n                        }\n                        else {\n                            this.expressionManager = null;\n                            this.expressions = {};\n                        }\n                        if (this.eyeBlink == null) {\n                            this.eyeBlink = new L2DEyeBlink();\n                        }\n                        if (this.modelSetting.getPhysicsFile() != null) {\n                            this.loadPhysics(this.modelHomeDir + this.modelSetting.getPhysicsFile());\n                        }\n                        else {\n                            this.physics = null;\n                        }\n                        if (this.modelSetting.getPoseFile() != null) {\n                            this.loadPose(this.modelHomeDir + this.modelSetting.getPoseFile(), () => {\n                                this.pose.updateParam(this.live2DModel);\n                            });\n                        }\n                        else {\n                            this.pose = null;\n                        }\n                        if (this.modelSetting.getLayout() != null) {\n                            const layout = this.modelSetting.getLayout();\n                            if (layout['width'] != null)\n                                this.modelMatrix.setWidth(layout['width']);\n                            if (layout['height'] != null)\n                                this.modelMatrix.setHeight(layout['height']);\n                            if (layout['x'] != null)\n                                this.modelMatrix.setX(layout['x']);\n                            if (layout['y'] != null)\n                                this.modelMatrix.setY(layout['y']);\n                            if (layout['center_x'] != null)\n                                this.modelMatrix.centerX(layout['center_x']);\n                            if (layout['center_y'] != null)\n                                this.modelMatrix.centerY(layout['center_y']);\n                            if (layout['top'] != null)\n                                this.modelMatrix.top(layout['top']);\n                            if (layout['bottom'] != null)\n                                this.modelMatrix.bottom(layout['bottom']);\n                            if (layout['left'] != null)\n                                this.modelMatrix.left(layout['left']);\n                            if (layout['right'] != null)\n                                this.modelMatrix.right(layout['right']);\n                        }\n                        for (let j = 0; j < this.modelSetting.getInitParamNum(); j++) {\n                            this.live2DModel.setParamFloat(this.modelSetting.getInitParamID(j), this.modelSetting.getInitParamValue(j));\n                        }\n                        for (let j = 0; j < this.modelSetting.getInitPartsVisibleNum(); j++) {\n                            this.live2DModel.setPartsOpacity(this.modelSetting.getInitPartsVisibleID(j), this.modelSetting.getInitPartsVisibleValue(j));\n                        }\n                        this.live2DModel.saveParam();\n                        this.preloadMotionGroup(LAppDefine.MOTION_GROUP_IDLE);\n                        this.mainMotionManager.stopAllMotions();\n                        this.setUpdating(false);\n                        this.setInitialized(true);\n                        if (typeof callback == 'function')\n                            callback();\n                    }\n                });\n            }\n        });\n    }\n    async loadModelSetting(modelSettingPath, modelSetting) {\n        this.setUpdating(true);\n        this.setInitialized(false);\n        this.modelHomeDir = modelSettingPath.substring(0, modelSettingPath.lastIndexOf('/') + 1);\n        this.modelSetting = new ModelSettingJson();\n        this.modelSetting.json = modelSetting;\n        await new Promise(resolve => this.loadJSON(resolve));\n    }\n    load(gl, modelSettingPath, callback) {\n        this.setUpdating(true);\n        this.setInitialized(false);\n        this.modelHomeDir = modelSettingPath.substring(0, modelSettingPath.lastIndexOf('/') + 1);\n        this.modelSetting = new ModelSettingJson();\n        this.modelSetting.loadModelSetting(modelSettingPath, () => {\n            this.loadJSON(callback);\n        });\n    }\n    release(gl) {\n        const pm = Live2DFramework.getPlatformManager();\n        gl.deleteTexture(pm.texture);\n    }\n    preloadMotionGroup(name) {\n        for (let i = 0; i < this.modelSetting.getMotionNum(name); i++) {\n            const file = this.modelSetting.getMotionFile(name, i);\n            this.loadMotion(file, this.modelHomeDir + file, motion => {\n                motion.setFadeIn(this.modelSetting.getMotionFadeIn(name, i));\n                motion.setFadeOut(this.modelSetting.getMotionFadeOut(name, i));\n            });\n        }\n    }\n    update() {\n        if (this.live2DModel == null) {\n            logger.error('Failed to update.');\n            return;\n        }\n        const timeMSec = UtSystem.getUserTimeMSec() - this.startTimeMSec;\n        const timeSec = timeMSec / 1000.0;\n        const t = timeSec * 2 * Math.PI;\n        if (this.mainMotionManager.isFinished()) {\n            this.startRandomMotion(LAppDefine.MOTION_GROUP_IDLE, LAppDefine.PRIORITY_IDLE);\n        }\n        this.live2DModel.loadParam();\n        const update = this.mainMotionManager.updateParam(this.live2DModel);\n        if (!update) {\n            if (this.eyeBlink != null) {\n                this.eyeBlink.updateParam(this.live2DModel);\n            }\n        }\n        this.live2DModel.saveParam();\n        if (this.expressionManager != null &&\n            this.expressions != null &&\n            !this.expressionManager.isFinished()) {\n            this.expressionManager.updateParam(this.live2DModel);\n        }\n        this.live2DModel.addToParamFloat('PARAM_ANGLE_X', this.dragX * 30, 1);\n        this.live2DModel.addToParamFloat('PARAM_ANGLE_Y', this.dragY * 30, 1);\n        this.live2DModel.addToParamFloat('PARAM_ANGLE_Z', this.dragX * this.dragY * -30, 1);\n        this.live2DModel.addToParamFloat('PARAM_BODY_ANGLE_X', this.dragX * 10, 1);\n        this.live2DModel.addToParamFloat('PARAM_EYE_BALL_X', this.dragX, 1);\n        this.live2DModel.addToParamFloat('PARAM_EYE_BALL_Y', this.dragY, 1);\n        this.live2DModel.addToParamFloat('PARAM_ANGLE_X', Number(15 * Math.sin(t / 6.5345)), 0.5);\n        this.live2DModel.addToParamFloat('PARAM_ANGLE_Y', Number(8 * Math.sin(t / 3.5345)), 0.5);\n        this.live2DModel.addToParamFloat('PARAM_ANGLE_Z', Number(10 * Math.sin(t / 5.5345)), 0.5);\n        this.live2DModel.addToParamFloat('PARAM_BODY_ANGLE_X', Number(4 * Math.sin(t / 15.5345)), 0.5);\n        this.live2DModel.setParamFloat('PARAM_BREATH', Number(0.5 + 0.5 * Math.sin(t / 3.2345)), 1);\n        if (this.physics != null) {\n            this.physics.updateParam(this.live2DModel);\n        }\n        if (this.lipSync == null) {\n            this.live2DModel.setParamFloat('PARAM_MOUTH_OPEN_Y', this.lipSyncValue);\n        }\n        if (this.pose != null) {\n            this.pose.updateParam(this.live2DModel);\n        }\n        this.live2DModel.update();\n    }\n    setRandomExpression() {\n        const tmp = [];\n        for (const name in this.expressions) {\n            tmp.push(name);\n        }\n        const no = parseInt(Math.random() * tmp.length);\n        this.setExpression(tmp[no]);\n    }\n    startRandomMotion(name, priority) {\n        const max = this.modelSetting.getMotionNum(name);\n        const no = parseInt(Math.random() * max);\n        this.startMotion(name, no, priority);\n    }\n    startMotion(name, no, priority) {\n        const motionName = this.modelSetting.getMotionFile(name, no);\n        if (motionName == null || motionName == '') {\n            return;\n        }\n        if (priority == LAppDefine.PRIORITY_FORCE) {\n            this.mainMotionManager.setReservePriority(priority);\n        }\n        else if (!this.mainMotionManager.reserveMotion(priority)) {\n            logger.trace('Motion is running.');\n            return;\n        }\n        let motion;\n        if (this.motions[name] == null) {\n            this.loadMotion(null, this.modelHomeDir + motionName, mtn => {\n                motion = mtn;\n                this.setFadeInFadeOut(name, no, priority, motion);\n            });\n        }\n        else {\n            motion = this.motions[name];\n            this.setFadeInFadeOut(name, no, priority, motion);\n        }\n    }\n    setFadeInFadeOut(name, no, priority, motion) {\n        const motionName = this.modelSetting.getMotionFile(name, no);\n        motion.setFadeIn(this.modelSetting.getMotionFadeIn(name, no));\n        motion.setFadeOut(this.modelSetting.getMotionFadeOut(name, no));\n        logger.trace('Start motion : ' + motionName);\n        if (this.modelSetting.getMotionSound(name, no) == null) {\n            this.mainMotionManager.startMotionPrio(motion, priority);\n        }\n        else {\n            const soundName = this.modelSetting.getMotionSound(name, no);\n            const snd = document.createElement('audio');\n            snd.src = this.modelHomeDir + soundName;\n            logger.trace('Start sound : ' + soundName);\n            snd.play();\n            this.mainMotionManager.startMotionPrio(motion, priority);\n        }\n    }\n    setExpression(name) {\n        var _b;\n        const motion = this.expressions[name];\n        logger.trace('Expression : ' + name);\n        (_b = this.expressionManager) === null || _b === void 0 ? void 0 : _b.startMotion(motion, false);\n    }\n    draw(gl) {\n        MatrixStack.push();\n        MatrixStack.multMatrix(this.modelMatrix.getArray());\n        this.tmpMatrix = MatrixStack.getMatrix();\n        this.live2DModel.setMatrix(this.tmpMatrix);\n        this.live2DModel.draw();\n        MatrixStack.pop();\n    }\n    hitTest(id, testX, testY) {\n        const len = this.modelSetting.getHitAreaNum();\n        if (len == 0) {\n            const hitAreasCustom = this.modelSetting.getHitAreaCustom();\n            if (hitAreasCustom) {\n                const x = hitAreasCustom[id + '_x'];\n                const y = hitAreasCustom[id + '_y'];\n                if (testX > Math.min(...x) && testX < Math.max(...x) &&\n                    testY > Math.min(...y) && testY < Math.max(...y)) {\n                    return true;\n                }\n            }\n        }\n        for (let i = 0; i < len; i++) {\n            if (id == this.modelSetting.getHitAreaName(i)) {\n                const drawID = this.modelSetting.getHitAreaID(i);\n                return this.hitTestSimple(drawID, testX, testY);\n            }\n        }\n        return false;\n    }\n}\nexport default LAppModel;\n","count_time":{"symbolsCount":"9.1k","symbolsTime":"8 mins."},"toc":"","data":[]}