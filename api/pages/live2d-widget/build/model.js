{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"import { showMessage } from './message.js'; import { loadExternalResource, randomOtherOption } from './utils.js'; import logger from './logg...","date":"2025-11-18T04:43:50.325Z","updated":"2025-11-18T04:43:50.325Z","comments":true,"path":"api/pages/live2d-widget/build/model.js","covers":null,"content":"import { showMessage } from './message.js';\nimport { loadExternalResource, randomOtherOption } from './utils.js';\nimport logger from './logger.js';\nclass ModelManager {\n    constructor(config, models = []) {\n        var _b;\n        this.modelList = null;\n        let { apiPath, cdnPath } = config;\n        const { cubism2Path, cubism5Path } = config;\n        let useCDN = false;\n        if (typeof cdnPath === 'string') {\n            if (!cdnPath.endsWith('/'))\n                cdnPath += '/';\n            useCDN = true;\n        }\n        else if (typeof apiPath === 'string') {\n            if (!apiPath.endsWith('/'))\n                apiPath += '/';\n            cdnPath = apiPath;\n            useCDN = true;\n            logger.warn('apiPath option is deprecated. Please use cdnPath instead.');\n        }\n        else if (!models.length) {\n            throw 'Invalid initWidget argument!';\n        }\n        let modelId = parseInt(localStorage.getItem('modelId'), 10);\n        let modelTexturesId = parseInt(localStorage.getItem('modelTexturesId'), 10);\n        if (isNaN(modelId) || isNaN(modelTexturesId)) {\n            modelTexturesId = 0;\n        }\n        if (isNaN(modelId)) {\n            modelId = (_b = config.modelId) !== null && _b !== void 0 ? _b : 0;\n        }\n        this.useCDN = useCDN;\n        this.cdnPath = cdnPath || '';\n        this.cubism2Path = cubism2Path || '';\n        this.cubism5Path = cubism5Path || '';\n        this._modelId = modelId;\n        this._modelTexturesId = modelTexturesId;\n        this.currentModelVersion = 0;\n        this.loading = false;\n        this.modelJSONCache = {};\n        this.models = models;\n    }\n    static async initCheck(config, models = []) {\n        const model = new ModelManager(config, models);\n        if (model.useCDN) {\n            const response = await fetch(`${model.cdnPath}model_list.json`);\n            model.modelList = await response.json();\n            if (model.modelId >= model.modelList.models.length) {\n                model.modelId = 0;\n            }\n            const modelName = model.modelList.models[model.modelId];\n            if (Array.isArray(modelName)) {\n                if (model.modelTexturesId >= modelName.length) {\n                    model.modelTexturesId = 0;\n                }\n            }\n            else {\n                const modelSettingPath = `${model.cdnPath}model/${modelName}/index.json`;\n                const modelSetting = await model.fetchWithCache(modelSettingPath);\n                const version = model.checkModelVersion(modelSetting);\n                if (version === 2) {\n                    const textureCache = await model.loadTextureCache(modelName);\n                    if (model.modelTexturesId >= textureCache.length) {\n                        model.modelTexturesId = 0;\n                    }\n                }\n            }\n        }\n        else {\n            if (model.modelId >= model.models.length) {\n                model.modelId = 0;\n            }\n            if (model.modelTexturesId >= model.models[model.modelId].paths.length) {\n                model.modelTexturesId = 0;\n            }\n        }\n        return model;\n    }\n    set modelId(modelId) {\n        this._modelId = modelId;\n        localStorage.setItem('modelId', modelId.toString());\n    }\n    get modelId() {\n        return this._modelId;\n    }\n    set modelTexturesId(modelTexturesId) {\n        this._modelTexturesId = modelTexturesId;\n        localStorage.setItem('modelTexturesId', modelTexturesId.toString());\n    }\n    get modelTexturesId() {\n        return this._modelTexturesId;\n    }\n    resetCanvas() {\n        document.getElementById('waifu-canvas').innerHTML = '<canvas id=\"live2d\" width=\"800\" height=\"800\"></canvas>';\n    }\n    async fetchWithCache(url) {\n        let result;\n        if (url in this.modelJSONCache) {\n            result = this.modelJSONCache[url];\n        }\n        else {\n            try {\n                const response = await fetch(url);\n                result = await response.json();\n            }\n            catch (_b) {\n                result = null;\n            }\n            this.modelJSONCache[url] = result;\n        }\n        return result;\n    }\n    checkModelVersion(modelSetting) {\n        if (modelSetting.Version === 3 || modelSetting.FileReferences) {\n            return 3;\n        }\n        return 2;\n    }\n    async loadLive2D(modelSettingPath, modelSetting) {\n        if (this.loading) {\n            logger.warn('Still loading. Abort.');\n            return;\n        }\n        this.loading = true;\n        try {\n            const version = this.checkModelVersion(modelSetting);\n            if (version === 2) {\n                if (!this.cubism2model) {\n                    if (!this.cubism2Path) {\n                        logger.error('No cubism2Path set, cannot load Cubism 2 Core.');\n                        return;\n                    }\n                    await loadExternalResource(this.cubism2Path, 'js');\n                    const { default: Cubism2Model } = await import('./cubism2/index.js');\n                    this.cubism2model = new Cubism2Model();\n                }\n                if (this.currentModelVersion === 3) {\n                    this.cubism5model.release();\n                    this.resetCanvas();\n                }\n                if (this.currentModelVersion === 3 || !this.cubism2model.gl) {\n                    await this.cubism2model.init('live2d', modelSettingPath, modelSetting);\n                }\n                else {\n                    await this.cubism2model.changeModelWithJSON(modelSettingPath, modelSetting);\n                }\n            }\n            else {\n                if (!this.cubism5Path) {\n                    logger.error('No cubism5Path set, cannot load Cubism 5 Core.');\n                    return;\n                }\n                await loadExternalResource(this.cubism5Path, 'js');\n                const { AppDelegate: Cubism5Model } = await import('./cubism5/index.js');\n                this.cubism5model = new Cubism5Model();\n                if (this.currentModelVersion === 2) {\n                    this.cubism2model.destroy();\n                    this.resetCanvas();\n                }\n                if (this.currentModelVersion === 2 || !this.cubism5model.subdelegates.at(0)) {\n                    this.cubism5model.initialize();\n                    this.cubism5model.changeModel(modelSettingPath);\n                    this.cubism5model.run();\n                }\n                else {\n                    this.cubism5model.changeModel(modelSettingPath);\n                }\n            }\n            logger.info(`Model ${modelSettingPath} (Cubism version ${version}) loaded`);\n            this.currentModelVersion = version;\n        }\n        catch (err) {\n            console.error('loadLive2D failed', err);\n        }\n        this.loading = false;\n    }\n    async loadTextureCache(modelName) {\n        const textureCache = await this.fetchWithCache(`${this.cdnPath}model/${modelName}/textures.cache`);\n        return textureCache || [];\n    }\n    async loadModel(message) {\n        let modelSettingPath, modelSetting;\n        if (this.useCDN) {\n            let modelName = this.modelList.models[this.modelId];\n            if (Array.isArray(modelName)) {\n                modelName = modelName[this.modelTexturesId];\n            }\n            modelSettingPath = `${this.cdnPath}model/${modelName}/index.json`;\n            modelSetting = await this.fetchWithCache(modelSettingPath);\n            const version = this.checkModelVersion(modelSetting);\n            if (version === 2) {\n                const textureCache = await this.loadTextureCache(modelName);\n                if (textureCache.length > 0) {\n                    let textures = textureCache[this.modelTexturesId];\n                    if (typeof textures === 'string')\n                        textures = [textures];\n                    modelSetting.textures = textures;\n                }\n            }\n        }\n        else {\n            modelSettingPath = this.models[this.modelId].paths[this.modelTexturesId];\n            modelSetting = await this.fetchWithCache(modelSettingPath);\n        }\n        await this.loadLive2D(modelSettingPath, modelSetting);\n        showMessage(message, 4000, 10);\n    }\n    async loadRandTexture(successMessage = '', failMessage = '') {\n        const { modelId } = this;\n        let noTextureAvailable = false;\n        if (this.useCDN) {\n            const modelName = this.modelList.models[modelId];\n            if (Array.isArray(modelName)) {\n                this.modelTexturesId = randomOtherOption(modelName.length, this.modelTexturesId);\n            }\n            else {\n                const modelSettingPath = `${this.cdnPath}model/${modelName}/index.json`;\n                const modelSetting = await this.fetchWithCache(modelSettingPath);\n                const version = this.checkModelVersion(modelSetting);\n                if (version === 2) {\n                    const textureCache = await this.loadTextureCache(modelName);\n                    if (textureCache.length <= 1) {\n                        noTextureAvailable = true;\n                    }\n                    else {\n                        this.modelTexturesId = randomOtherOption(textureCache.length, this.modelTexturesId);\n                    }\n                }\n                else {\n                    noTextureAvailable = true;\n                }\n            }\n        }\n        else {\n            if (this.models[modelId].paths.length === 1) {\n                noTextureAvailable = true;\n            }\n            else {\n                this.modelTexturesId = randomOtherOption(this.models[modelId].paths.length, this.modelTexturesId);\n            }\n        }\n        if (noTextureAvailable) {\n            showMessage(failMessage, 4000, 10);\n        }\n        else {\n            await this.loadModel(successMessage);\n        }\n    }\n    async loadNextModel() {\n        this.modelTexturesId = 0;\n        if (this.useCDN) {\n            this.modelId = (this.modelId + 1) % this.modelList.models.length;\n            await this.loadModel(this.modelList.messages[this.modelId]);\n        }\n        else {\n            this.modelId = (this.modelId + 1) % this.models.length;\n            await this.loadModel(this.models[this.modelId].message);\n        }\n    }\n}\nexport { ModelManager };\n","count_time":{"symbolsCount":"10k","symbolsTime":"9 mins."},"toc":"","data":[]}