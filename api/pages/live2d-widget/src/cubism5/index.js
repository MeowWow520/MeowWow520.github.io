{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"/* global document, window, Event */ import { LAppDelegate } from '@demo/lappdelegate.js'; import { LAppSubdelegate } from '@demo/lappsubdel...","date":"2025-11-18T04:43:50.345Z","updated":"2025-11-18T04:43:50.345Z","comments":true,"path":"api/pages/live2d-widget/src/cubism5/index.js","covers":null,"content":"/* global document, window, Event */\n\nimport { LAppDelegate } from '@demo/lappdelegate.js';\nimport { LAppSubdelegate } from '@demo/lappsubdelegate.js';\nimport * as LAppDefine from '@demo/lappdefine.js';\nimport { LAppModel } from '@demo/lappmodel.js';\nimport { LAppPal } from '@demo/lapppal';\nimport logger from '../logger.js';\n\nLAppPal.printMessage = () => {};\n\n// Custom subdelegate class, responsible for Canvas-related initialization and rendering management\nclass AppSubdelegate extends LAppSubdelegate {\n  /**\n   * Initialize resources required by the application.\n   * @param {HTMLCanvasElement} canvas The canvas object passed in\n   */\n  initialize(canvas) {\n    // Initialize WebGL manager, return false if failed\n    if (!this._glManager.initialize(canvas)) {\n      return false;\n    }\n\n    this._canvas = canvas;\n\n    // Canvas size setting, supports auto and specified size\n    if (LAppDefine.CanvasSize === 'auto') {\n      this.resizeCanvas();\n    } else {\n      canvas.width = LAppDefine.CanvasSize.width;\n      canvas.height = LAppDefine.CanvasSize.height;\n    }\n\n    // Set the GL manager for the texture manager\n    this._textureManager.setGlManager(this._glManager);\n\n    const gl = this._glManager.getGl();\n\n    // If the framebuffer object is not initialized, get the current framebuffer binding\n    if (!this._frameBuffer) {\n      this._frameBuffer = gl.getParameter(gl.FRAMEBUFFER_BINDING);\n    }\n\n    // Enable blend mode for transparency\n    gl.enable(gl.BLEND);\n    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\n\n    // Initialize the view (AppView)\n    this._view.initialize(this);\n    this._view._gear = {\n      render: () => {},\n      isHit: () => {},\n      release: () => {}\n    };\n    this._view._back = {\n      render: () => {},\n      release: () => {}\n    };\n    // this._view.initializeSprite();\n\n    // Associate Live2D manager with the current subdelegate\n    // this._live2dManager.initialize(this);\n    this._live2dManager._subdelegate = this;\n\n    // Listen for canvas size changes for responsive adaptation\n    this._resizeObserver = new window.ResizeObserver(\n      (entries, observer) =>\n        this.resizeObserverCallback.call(this, entries, observer)\n    );\n    this._resizeObserver.observe(this._canvas);\n\n    return true;\n  }\n\n  /**\n   * Adjust and reinitialize the view when the canvas size changes\n   */\n  onResize() {\n    this.resizeCanvas();\n    this._view.initialize(this);\n    // this._view.initializeSprite();\n  }\n\n  /**\n   * Main render loop, called periodically to update the screen\n   */\n  update() {\n    // Check if the WebGL context is lost, if so, stop rendering\n    if (this._glManager.getGl().isContextLost()) {\n      return;\n    }\n\n    // If resize is needed, call onResize\n    if (this._needResize) {\n      this.onResize();\n      this._needResize = false;\n    }\n\n    const gl = this._glManager.getGl();\n\n    // Initialize the canvas as fully transparent\n    gl.clearColor(0.0, 0.0, 0.0, 0.0);\n\n    // Enable depth test to ensure correct model occlusion\n    gl.enable(gl.DEPTH_TEST);\n\n    // Set depth function so nearer objects cover farther ones\n    gl.depthFunc(gl.LEQUAL);\n\n    // Clear color and depth buffers\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n    gl.clearDepth(1.0);\n\n    // Enable blend mode again to ensure transparency\n    gl.enable(gl.BLEND);\n    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\n\n    // Render the view content\n    this._view.render();\n  }\n}\n\n// Main application delegate class, responsible for managing the main loop, canvas, model switching, and other global logic\nexport class AppDelegate extends LAppDelegate {\n  /**\n   * Start the main loop.\n   */\n  run() {\n    // Main loop function, responsible for updating time and all subdelegates\n    const loop = () => {\n      // Update time\n      LAppPal.updateTime();\n\n      // Iterate all subdelegates and call update for rendering\n      for (let i = 0; i < this._subdelegates.getSize(); i++) {\n        this._subdelegates.at(i).update();\n      }\n\n      // Recursive call for animation loop\n      this._drawFrameId = window.requestAnimationFrame(loop);\n    };\n    loop();\n  }\n\n  stop() {\n    if (this._drawFrameId) {\n      window.cancelAnimationFrame(this._drawFrameId);\n      this._drawFrameId = null;\n    }\n  }\n\n  release() {\n    this.stop();\n    this.releaseEventListener();\n    this._subdelegates.clear();\n\n    this._cubismOption = null;\n  }\n\n  transformOffset(e) {\n    const subdelegate = this._subdelegates.at(0);\n    const rect = subdelegate.getCanvas().getBoundingClientRect();\n    const localX = e.pageX - rect.left;\n    const localY = e.pageY - rect.top;\n    const posX = localX * window.devicePixelRatio;\n    const posY = localY * window.devicePixelRatio;\n    const x = subdelegate._view.transformViewX(posX);\n    const y = subdelegate._view.transformViewY(posY);\n    return {\n      x, y\n    };\n  }\n\n  onMouseMove(e) {\n    const lapplive2dmanager = this._subdelegates.at(0).getLive2DManager();\n    const { x, y } = this.transformOffset(e);\n    const model = lapplive2dmanager._models.at(0);\n\n    lapplive2dmanager.onDrag(x, y);\n    lapplive2dmanager.onTap(x, y);\n    if (model.hitTest(LAppDefine.HitAreaNameBody, x, y)) {\n      window.dispatchEvent(new Event('live2d:hoverbody'));\n    }\n  }\n\n  onMouseEnd(e) {\n    const lapplive2dmanager = this._subdelegates.at(0).getLive2DManager();\n    const { x, y } = this.transformOffset(e);\n    lapplive2dmanager.onDrag(0.0, 0.0);\n    lapplive2dmanager.onTap(x, y);\n  }\n\n  onTap(e) {\n    const lapplive2dmanager = this._subdelegates.at(0).getLive2DManager();\n    const { x, y } = this.transformOffset(e);\n    const model = lapplive2dmanager._models.at(0);\n\n    if (model.hitTest(LAppDefine.HitAreaNameBody, x, y)) {\n      window.dispatchEvent(new Event('live2d:tapbody'));\n    }\n  }\n\n  initializeEventListener() {\n    this.mouseMoveEventListener = this.onMouseMove.bind(this);\n    this.mouseEndedEventListener = this.onMouseEnd.bind(this);\n    this.tapEventListener = this.onTap.bind(this);\n\n    document.addEventListener('mousemove', this.mouseMoveEventListener, {\n      passive: true\n    });\n    document.addEventListener('mouseout', this.mouseEndedEventListener, {\n      passive: true\n    });\n    document.addEventListener('pointerdown', this.tapEventListener, {\n      passive: true\n    });\n  }\n\n  releaseEventListener() {\n    document.removeEventListener('mousemove', this.mouseMoveEventListener, {\n      passive: true\n    });\n    this.mouseMoveEventListener = null;\n    document.removeEventListener('mouseout', this.mouseEndedEventListener, {\n      passive: true\n    });\n    this.mouseEndedEventListener = null;\n    document.removeEventListener('pointerdown', this.tapEventListener, {\n      passive: true\n    });\n  }\n\n  /**\n   * Create canvas and initialize all Subdelegates\n   */\n  initializeSubdelegates() {\n    // Reserve space to improve performance\n    this._canvases.prepareCapacity(LAppDefine.CanvasNum);\n    this._subdelegates.prepareCapacity(LAppDefine.CanvasNum);\n\n    // Get the live2d canvas element from the page\n    const canvas = document.getElementById('live2d');\n    this._canvases.pushBack(canvas);\n\n    // Set canvas style size to match actual size\n    canvas.style.width = canvas.width;\n    canvas.style.height = canvas.height;\n\n    // For each canvas, create a subdelegate and complete initialization\n    for (let i = 0; i < this._canvases.getSize(); i++) {\n      const subdelegate = new AppSubdelegate();\n      const result = subdelegate.initialize(this._canvases.at(i));\n      if (!result) {\n        logger.error('Failed to initialize AppSubdelegate');\n        return;\n      }\n      this._subdelegates.pushBack(subdelegate);\n    }\n\n    // Check if the WebGL context of each subdelegate is lost\n    for (let i = 0; i < LAppDefine.CanvasNum; i++) {\n      if (this._subdelegates.at(i).isContextLost()) {\n        logger.error(\n          `The context for Canvas at index ${i} was lost, possibly because the acquisition limit for WebGLRenderingContext was reached.`\n        );\n      }\n    }\n  }\n\n  /**\n   * Switch model\n   * @param {string} modelSettingPath Path to the model setting file\n   */\n  changeModel(modelSettingPath) {\n    const segments = modelSettingPath.split('/');\n    const modelJsonName = segments.pop();\n    const modelPath = segments.join('/') + '/';\n    // Get the current Live2D manager\n    const live2dManager = this._subdelegates.at(0).getLive2DManager();\n    // Release all old models\n    live2dManager.releaseAllModel();\n    // Create a new model instance, set subdelegate and load resources\n    const instance = new LAppModel();\n    instance.setSubdelegate(live2dManager._subdelegate);\n    instance.loadAssets(modelPath, modelJsonName);\n    // Add the new model to the model list\n    live2dManager._models.pushBack(instance);\n  }\n\n  get subdelegates() {\n    return this._subdelegates;\n  }\n}\n","count_time":{"symbolsCount":"8.9k","symbolsTime":"8 mins."},"toc":"","data":[]}