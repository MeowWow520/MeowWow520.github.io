{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"/* global document, window, Event, Live2D */ import { L2DMatrix44, L2DTargetPoint, L2DViewMatrix } from './Live2DFramework.js'; import LAppD...","date":"2025-11-18T04:43:50.344Z","updated":"2025-11-18T04:43:50.344Z","comments":true,"path":"api/pages/live2d-widget/src/cubism2/index.js","covers":null,"content":"/* global document, window, Event, Live2D */\nimport { L2DMatrix44, L2DTargetPoint, L2DViewMatrix } from './Live2DFramework.js';\nimport LAppDefine from './LAppDefine.js';\nimport MatrixStack from './utils/MatrixStack.js';\nimport LAppLive2DManager from './LAppLive2DManager.js';\nimport logger from '../logger.js';\n\nfunction normalizePoint(x, y, x0, y0, w, h) {\n  const dx = x - x0;\n  const dy = y - y0;\n\n  let targetX = 0, targetY = 0;\n\n  if (dx >= 0) {\n    targetX = dx / (w - x0);\n  } else {\n    targetX = dx / x0;\n  }\n  if (dy >= 0) {\n    targetY = dy / (h - y0);\n  } else {\n    targetY = dy / y0;\n  }\n  return {\n    vx: targetX,\n    vy: -targetY\n  };\n}\n\nclass Cubism2Model {\n  constructor() {\n    this.live2DMgr = new LAppLive2DManager();\n\n    this.isDrawStart = false;\n\n    this.gl = null;\n    this.canvas = null;\n\n    this.dragMgr = null; /*new L2DTargetPoint();*/\n    this.viewMatrix = null; /*new L2DViewMatrix();*/\n    this.projMatrix = null; /*new L2DMatrix44()*/\n    this.deviceToScreen = null; /*new L2DMatrix44();*/\n\n    this.oldLen = 0;\n\n    this._boundMouseEvent = this.mouseEvent.bind(this);\n    this._boundTouchEvent = this.touchEvent.bind(this);\n  }\n\n  initL2dCanvas(canvasId) {\n    this.canvas = document.getElementById(canvasId);\n\n    if (this.canvas.addEventListener) {\n      this.canvas.addEventListener('mousewheel', this._boundMouseEvent, false);\n      this.canvas.addEventListener('click', this._boundMouseEvent, false);\n\n      document.addEventListener('mousemove', this._boundMouseEvent, false);\n\n      document.addEventListener('mouseout', this._boundMouseEvent, false);\n      this.canvas.addEventListener('contextmenu', this._boundMouseEvent, false);\n\n      this.canvas.addEventListener('touchstart', this._boundTouchEvent, false);\n      this.canvas.addEventListener('touchend', this._boundTouchEvent, false);\n      this.canvas.addEventListener('touchmove', this._boundTouchEvent, false);\n    }\n  }\n\n  async init(canvasId, modelSettingPath, modelSetting) {\n    this.initL2dCanvas(canvasId);\n    const width = this.canvas.width;\n    const height = this.canvas.height;\n\n    this.dragMgr = new L2DTargetPoint();\n\n    const ratio = height / width;\n    const left = LAppDefine.VIEW_LOGICAL_LEFT;\n    const right = LAppDefine.VIEW_LOGICAL_RIGHT;\n    const bottom = -ratio;\n    const top = ratio;\n\n    this.viewMatrix = new L2DViewMatrix();\n\n    this.viewMatrix.setScreenRect(left, right, bottom, top);\n\n    this.viewMatrix.setMaxScreenRect(\n      LAppDefine.VIEW_LOGICAL_MAX_LEFT,\n      LAppDefine.VIEW_LOGICAL_MAX_RIGHT,\n      LAppDefine.VIEW_LOGICAL_MAX_BOTTOM,\n      LAppDefine.VIEW_LOGICAL_MAX_TOP,\n    );\n\n    this.viewMatrix.setMaxScale(LAppDefine.VIEW_MAX_SCALE);\n    this.viewMatrix.setMinScale(LAppDefine.VIEW_MIN_SCALE);\n\n    this.projMatrix = new L2DMatrix44();\n    this.projMatrix.multScale(1, width / height);\n\n    this.deviceToScreen = new L2DMatrix44();\n    this.deviceToScreen.multTranslate(-width / 2.0, -height / 2.0);\n    this.deviceToScreen.multScale(2 / width, -2 / width);\n\n    // https://stackoverflow.com/questions/26783586/canvas-todataurl-returns-blank-image\n    this.gl = this.canvas.getContext('webgl2', { premultipliedAlpha: true, preserveDrawingBuffer: true });\n    if (!this.gl) {\n      logger.error('Failed to create WebGL context.');\n      return;\n    }\n\n    Live2D.setGL(this.gl);\n\n    this.gl.clearColor(0.0, 0.0, 0.0, 0.0);\n\n    await this.changeModelWithJSON(modelSettingPath, modelSetting);\n\n    this.startDraw();\n  }\n\n  destroy() {\n    // 1. Unbind canvas events\n    if (this.canvas) {\n      this.canvas.removeEventListener('mousewheel', this._boundMouseEvent, false);\n      this.canvas.removeEventListener('click', this._boundMouseEvent, false);\n      document.removeEventListener('mousemove', this._boundMouseEvent, false);\n      document.removeEventListener('mouseout', this._boundMouseEvent, false);\n      this.canvas.removeEventListener('contextmenu', this._boundMouseEvent, false);\n\n      this.canvas.removeEventListener('touchstart', this._boundTouchEvent, false);\n      this.canvas.removeEventListener('touchend', this._boundTouchEvent, false);\n      this.canvas.removeEventListener('touchmove', this._boundTouchEvent, false);\n    }\n\n    // 2. Stop animation\n    if (this._drawFrameId) {\n      window.cancelAnimationFrame(this._drawFrameId);\n      this._drawFrameId = null;\n    }\n    this.isDrawStart = false;\n\n    // 3. Release Live2D related resources\n    if (this.live2DMgr && typeof this.live2DMgr.release === 'function') {\n      this.live2DMgr.release();\n    }\n\n    // 4. Clean up WebGL resources (if any)\n    if (this.gl) {\n      // Implemented via resetCanvas\n    }\n\n    // 5. Clear references to assist GC\n    this.canvas = null;\n    this.gl = null;\n    // this.live2DMgr = null;\n    this.dragMgr = null;\n    this.viewMatrix = null;\n    this.projMatrix = null;\n    this.deviceToScreen = null;\n  }\n\n  startDraw() {\n    if (!this.isDrawStart) {\n      this.isDrawStart = true;\n      const tick = () => {\n        this.draw();\n        this._drawFrameId = window.requestAnimationFrame(tick, this.canvas);\n      };\n      tick();\n    }\n  }\n\n  draw() {\n    // logger.trace(\"--> draw()\");\n\n    MatrixStack.reset();\n    MatrixStack.loadIdentity();\n\n    this.dragMgr.update();\n    this.live2DMgr.setDrag(this.dragMgr.getX(), this.dragMgr.getY());\n\n    this.gl.clear(this.gl.COLOR_BUFFER_BIT);\n\n    MatrixStack.multMatrix(this.projMatrix.getArray());\n    MatrixStack.multMatrix(this.viewMatrix.getArray());\n    MatrixStack.push();\n\n    const model = this.live2DMgr.getModel();\n\n    if (model == null) return;\n\n    if (model.initialized && !model.updating) {\n      model.update();\n      model.draw(this.gl);\n    }\n\n    MatrixStack.pop();\n  }\n\n  async changeModel(modelSettingPath) {\n    await this.live2DMgr.changeModel(this.gl, modelSettingPath);\n  }\n\n  async changeModelWithJSON(modelSettingPath, modelSetting) {\n    await this.live2DMgr.changeModelWithJSON(this.gl, modelSettingPath, modelSetting);\n  }\n\n  modelScaling(scale) {\n    const isMaxScale = this.viewMatrix.isMaxScale();\n    const isMinScale = this.viewMatrix.isMinScale();\n\n    this.viewMatrix.adjustScale(0, 0, scale);\n\n    if (!isMaxScale) {\n      if (this.viewMatrix.isMaxScale()) {\n        this.live2DMgr.maxScaleEvent();\n      }\n    }\n\n    if (!isMinScale) {\n      if (this.viewMatrix.isMinScale()) {\n        this.live2DMgr.minScaleEvent();\n      }\n    }\n  }\n\n  modelTurnHead(event) {\n    const rect = this.canvas.getBoundingClientRect();\n\n    const { vx, vy } = normalizePoint(event.clientX, event.clientY, rect.left + rect.width / 2, rect.top + rect.height / 2, window.innerWidth, window.innerHeight);\n\n    logger.trace(\n      'onMouseDown device( x:' +\n      event.clientX +\n      ' y:' +\n      event.clientY +\n      ' ) view( x:' +\n      vx +\n      ' y:' +\n      vy +\n      ')',\n    );\n\n    this.dragMgr.setPoint(vx, vy);\n    this.live2DMgr.tapEvent(vx, vy);\n\n    if (this.live2DMgr?.model.hitTest(LAppDefine.HIT_AREA_BODY, vx, vy)) {\n      window.dispatchEvent(new Event('live2d:tapbody'));\n    }\n  }\n\n  followPointer(event) {\n    const rect = this.canvas.getBoundingClientRect();\n\n    const { vx, vy } = normalizePoint(event.clientX, event.clientY, rect.left + rect.width / 2, rect.top + rect.height / 2, window.innerWidth, window.innerHeight);\n\n    logger.trace(\n      'onMouseMove device( x:' +\n      event.clientX +\n      ' y:' +\n      event.clientY +\n      ' ) view( x:' +\n      vx +\n      ' y:' +\n      vy +\n      ')',\n    );\n\n    this.dragMgr.setPoint(vx, vy);\n\n    if (this.live2DMgr?.model.hitTest(LAppDefine.HIT_AREA_BODY, vx, vy)) {\n      window.dispatchEvent(new Event('live2d:hoverbody'));\n    }\n  }\n\n  lookFront() {\n    this.dragMgr.setPoint(0, 0);\n  }\n\n  mouseEvent(e) {\n    e.preventDefault();\n\n    if (e.type == 'mousewheel') {\n      if (e.wheelDelta > 0) this.modelScaling(1.1);\n      else this.modelScaling(0.9);\n    } else if (e.type == 'click' || e.type == 'contextmenu') {\n      this.modelTurnHead(e);\n    } else if (e.type == 'mousemove') {\n      this.followPointer(e);\n    } else if (e.type == 'mouseout') {\n      this.lookFront();\n    }\n  }\n\n  touchEvent(e) {\n    e.preventDefault();\n\n    const touch = e.touches[0];\n\n    if (e.type == 'touchstart') {\n      if (e.touches.length == 1) this.modelTurnHead(touch);\n      // onClick(touch);\n    } else if (e.type == 'touchmove') {\n      this.followPointer(touch);\n\n      if (e.touches.length == 2) {\n        const touch1 = e.touches[0];\n        const touch2 = e.touches[1];\n\n        const len =\n          Math.pow(touch1.pageX - touch2.pageX, 2) +\n          Math.pow(touch1.pageY - touch2.pageY, 2);\n        if (this.oldLen - len < 0) this.modelScaling(1.025);\n        else this.modelScaling(0.975);\n\n        this.oldLen = len;\n      }\n    } else if (e.type == 'touchend') {\n      this.lookFront();\n    }\n  }\n\n  transformViewX(deviceX) {\n    const screenX = this.deviceToScreen.transformX(deviceX);\n    return this.viewMatrix.invertTransformX(screenX);\n  }\n\n  transformViewY(deviceY) {\n    const screenY = this.deviceToScreen.transformY(deviceY);\n    return this.viewMatrix.invertTransformY(screenY);\n  }\n\n  transformScreenX(deviceX) {\n    return this.deviceToScreen.transformX(deviceX);\n  }\n\n  transformScreenY(deviceY) {\n    return this.deviceToScreen.transformY(deviceY);\n  }\n}\n\nexport default Cubism2Model;\n","count_time":{"symbolsCount":"9.3k","symbolsTime":"8 mins."},"toc":"","data":[]}