{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"/* global Live2D, Live2DMotion, AMotion, UtSystem, MotionQueueManager, PhysicsHair, UtDebug, PartsDataID */ /** * * You can modify and use t...","date":"2025-11-18T04:43:50.344Z","updated":"2025-11-18T04:43:50.344Z","comments":true,"path":"api/pages/live2d-widget/src/cubism2/Live2DFramework.js","covers":null,"content":"/* global Live2D, Live2DMotion, AMotion, UtSystem, MotionQueueManager, PhysicsHair, UtDebug, PartsDataID */\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\nimport logger from '../logger.js';\n//============================================================\n//============================================================\n//  class L2DBaseModel\n//============================================================\n//============================================================\nclass L2DBaseModel {\n  constructor() {\n    this.live2DModel = null; // ALive2DModel\n    this.modelMatrix = null; // L2DModelMatrix\n    this.eyeBlink = null; // L2DEyeBlink\n    this.physics = null; // L2DPhysics\n    this.pose = null; // L2DPose\n    this.initialized = false;\n    this.updating = false;\n    this.alpha = 1;\n    this.accAlpha = 0;\n    this.lipSync = false;\n    this.lipSyncValue = 0;\n    this.accelX = 0;\n    this.accelY = 0;\n    this.accelZ = 0;\n    this.dragX = 0;\n    this.dragY = 0;\n    this.startTimeMSec = null;\n    this.mainMotionManager = new L2DMotionManager(); //L2DMotionManager\n    this.expressionManager = new L2DMotionManager(); //L2DMotionManager\n    this.motions = {};\n    this.expressions = {};\n\n    this.isTexLoaded = false;\n  }\n\n  //============================================================\n  //    L2DBaseModel # getModelMatrix()\n  //============================================================\n  getModelMatrix() {\n    return this.modelMatrix;\n  }\n\n  //============================================================\n  //    L2DBaseModel # setAlpha()\n  //============================================================\n  setAlpha(a /*float*/) {\n    if (a > 0.999) a = 1;\n    if (a < 0.001) a = 0;\n    this.alpha = a;\n  }\n\n  //============================================================\n  //    L2DBaseModel # getAlpha()\n  //============================================================\n  getAlpha() {\n    return this.alpha;\n  }\n\n  //============================================================\n  //    L2DBaseModel # isInitialized()\n  //============================================================\n  isInitialized() {\n    return this.initialized;\n  }\n\n  //============================================================\n  //    L2DBaseModel # setInitialized()\n  //============================================================\n  setInitialized(v /*boolean*/) {\n    this.initialized = v;\n  }\n\n  //============================================================\n  //    L2DBaseModel # isUpdating()\n  //============================================================\n  isUpdating() {\n    return this.updating;\n  }\n\n  //============================================================\n  //    L2DBaseModel # setUpdating()\n  //============================================================\n  setUpdating(v /*boolean*/) {\n    this.updating = v;\n  }\n\n  //============================================================\n  //    L2DBaseModel # getLive2DModel()\n  //============================================================\n  getLive2DModel() {\n    return this.live2DModel;\n  }\n\n  //============================================================\n  //    L2DBaseModel # setLipSync()\n  //============================================================\n  setLipSync(v /*boolean*/) {\n    this.lipSync = v;\n  }\n\n  //============================================================\n  //    L2DBaseModel # setLipSyncValue()\n  //============================================================\n  setLipSyncValue(v /*float*/) {\n    this.lipSyncValue = v;\n  }\n\n  //============================================================\n  //    L2DBaseModel # setAccel()\n  //============================================================\n  setAccel(x /*float*/, y /*float*/, z /*float*/) {\n    this.accelX = x;\n    this.accelY = y;\n    this.accelZ = z;\n  }\n\n  //============================================================\n  //    L2DBaseModel # setDrag()\n  //============================================================\n  setDrag(x /*float*/, y /*float*/) {\n    this.dragX = x;\n    this.dragY = y;\n  }\n\n  //============================================================\n  //    L2DBaseModel # getMainMotionManager()\n  //============================================================\n  getMainMotionManager() {\n    return this.mainMotionManager;\n  }\n\n  //============================================================\n  //    L2DBaseModel # getExpressionManager()\n  //============================================================\n  getExpressionManager() {\n    return this.expressionManager;\n  }\n\n  //============================================================\n  //    L2DBaseModel # loadModelData()\n  //============================================================\n  loadModelData(path /*String*/, callback) {\n    /*\n        if( this.live2DModel != null ) {\n            this.live2DModel.deleteTextures();\n        }\n        */\n    const pm = Live2DFramework.getPlatformManager(); //IPlatformManager\n    logger.info('Load model : ' + path);\n\n    pm.loadLive2DModel(path, (l2dModel) => {\n      this.live2DModel = l2dModel;\n      this.live2DModel.saveParam();\n\n      const _err = Live2D.getError();\n\n      if (_err != 0) {\n        logger.error('Error : Failed to loadModelData().');\n        return;\n      }\n\n      this.modelMatrix = new L2DModelMatrix(\n        this.live2DModel.getCanvasWidth(),\n        this.live2DModel.getCanvasHeight(),\n      ); //L2DModelMatrix\n      this.modelMatrix.setWidth(2);\n      this.modelMatrix.setCenterPosition(0, 0);\n\n      callback(this.live2DModel);\n    });\n  }\n\n  //============================================================\n  //    L2DBaseModel # loadTexture()\n  //============================================================\n  loadTexture(no /*int*/, path /*String*/, callback) {\n    texCounter++;\n\n    const pm = Live2DFramework.getPlatformManager(); //IPlatformManager\n\n    logger.info('Load Texture : ' + path);\n\n    pm.loadTexture(this.live2DModel, no, path, () => {\n      texCounter--;\n      if (texCounter == 0) this.isTexLoaded = true;\n      if (typeof callback == 'function') callback();\n    });\n  }\n\n  //============================================================\n  //    L2DBaseModel # loadMotion()\n  //============================================================\n  loadMotion(name /*String*/, path /*String*/, callback) {\n    const pm = Live2DFramework.getPlatformManager(); //IPlatformManager\n\n    logger.trace('Load Motion : ' + path);\n\n    let motion = null; //Live2DMotion\n\n    pm.loadBytes(path, (buf) => {\n      motion = Live2DMotion.loadMotion(buf);\n      if (name != null) {\n        this.motions[name] = motion;\n      }\n      callback(motion);\n    });\n  }\n\n  //============================================================\n  //    L2DBaseModel # loadExpression()\n  //============================================================\n  loadExpression(name /*String*/, path /*String*/, callback) {\n    const pm = Live2DFramework.getPlatformManager(); //IPlatformManager\n\n    logger.trace('Load Expression : ' + path);\n\n    pm.loadBytes(path, (buf) => {\n      if (name != null) {\n        this.expressions[name] = L2DExpressionMotion.loadJson(buf);\n      }\n      if (typeof callback == 'function') callback();\n    });\n  }\n\n  //============================================================\n  //    L2DBaseModel # loadPose()\n  //============================================================\n  loadPose(path /*String*/, callback) {\n    const pm = Live2DFramework.getPlatformManager(); //IPlatformManager\n    logger.trace('Load Pose : ' + path);\n    try {\n      pm.loadBytes(path, (buf) => {\n        this.pose = L2DPose.load(buf);\n        if (typeof callback == 'function') callback();\n      });\n    } catch (e) {\n      logger.warn(e);\n    }\n  }\n\n  //============================================================\n  //    L2DBaseModel # loadPhysics()\n  //============================================================\n  loadPhysics(path /*String*/) {\n    const pm = Live2DFramework.getPlatformManager(); //IPlatformManager\n    logger.trace('Load Physics : ' + path);\n    try {\n      pm.loadBytes(path, (buf) => {\n        this.physics = L2DPhysics.load(buf);\n      });\n    } catch (e) {\n      logger.warn(e);\n    }\n  }\n\n  //============================================================\n  //    L2DBaseModel # hitTestSimple()\n  //============================================================\n  hitTestSimple(drawID, testX, testY) {\n    const drawIndex = this.live2DModel.getDrawDataIndex(drawID);\n\n    if (drawIndex < 0) return false;\n\n    const points = this.live2DModel.getTransformedPoints(drawIndex);\n    let left = this.live2DModel.getCanvasWidth();\n    let right = 0;\n    let top = this.live2DModel.getCanvasHeight();\n    let bottom = 0;\n\n    for (let j = 0; j < points.length; j = j + 2) {\n      const x = points[j];\n      const y = points[j + 1];\n\n      if (x < left) left = x;\n      if (x > right) right = x;\n      if (y < top) top = y;\n      if (y > bottom) bottom = y;\n    }\n    const tx = this.modelMatrix.invertTransformX(testX);\n    const ty = this.modelMatrix.invertTransformY(testY);\n\n    return left <= tx && tx <= right && top <= ty && ty <= bottom;\n  }\n}\n\nlet texCounter = 0;\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DExpressionMotion  extends     AMotion\n//============================================================\n//============================================================\nclass L2DExpressionMotion extends AMotion {\n  constructor() {\n    super();\n    this.paramList = []; //ArrayList<L2DExpressionParam>\n  }\n\n  //============================================================\n  //    static L2DExpressionMotion.loadJson()\n  //============================================================\n  static loadJson(buf) {\n    const ret = new L2DExpressionMotion();\n\n    const pm = Live2DFramework.getPlatformManager();\n    const json = pm.jsonParseFromBytes(buf);\n\n    ret.setFadeIn(parseInt(json.fade_in) > 0 ? parseInt(json.fade_in) : 1000);\n    ret.setFadeOut(\n      parseInt(json.fade_out) > 0 ? parseInt(json.fade_out) : 1000,\n    );\n\n    if (json.params == null) {\n      return ret;\n    }\n\n    const params = json.params;\n    const paramNum = params.length;\n    ret.paramList = []; //ArrayList<L2DExpressionParam>\n    for (let i = 0; i < paramNum; i++) {\n      const param = params[i];\n      const paramID = param.id.toString();\n      let value = parseFloat(param.val);\n      let calcTypeInt = L2DExpressionMotion.TYPE_ADD;\n      const calc = param.calc != null ? param.calc.toString() : 'add';\n      if (calc === 'add') {\n        calcTypeInt = L2DExpressionMotion.TYPE_ADD;\n      } else if (calc === 'mult') {\n        calcTypeInt = L2DExpressionMotion.TYPE_MULT;\n      } else if (calc === 'set') {\n        calcTypeInt = L2DExpressionMotion.TYPE_SET;\n      } else {\n        calcTypeInt = L2DExpressionMotion.TYPE_ADD;\n      }\n      if (calcTypeInt == L2DExpressionMotion.TYPE_ADD) {\n        let defaultValue = param.def == null ? 0 : parseFloat(param.def);\n        value = value - defaultValue;\n      } else if (calcTypeInt == L2DExpressionMotion.TYPE_MULT) {\n        let defaultValue = param.def == null ? 1 : parseFloat(param.def);\n        if (defaultValue == 0) defaultValue = 1;\n        value = value / defaultValue;\n      }\n\n      const item = new L2DExpressionParam();\n      item.id = paramID;\n      item.type = calcTypeInt;\n      item.value = value;\n\n      ret.paramList.push(item);\n    }\n\n    return ret;\n  }\n\n  //============================================================\n  //    L2DExpressionMotion # updateParamExe()\n  //============================================================\n  updateParamExe(\n    model /*ALive2DModel*/,\n    timeMSec /*long*/,\n    weight /*float*/,\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    motionQueueEnt /*MotionQueueEnt*/,\n  ) {\n    for (let i = this.paramList.length - 1; i >= 0; --i) {\n      const param = this.paramList[i]; //L2DExpressionParam\n      // if (!param || !param.type) continue;\n      if (param.type == L2DExpressionMotion.TYPE_ADD) {\n        model.addToParamFloat(param.id, param.value, weight);\n      } else if (param.type == L2DExpressionMotion.TYPE_MULT) {\n        model.multParamFloat(param.id, param.value, weight);\n      } else if (param.type == L2DExpressionMotion.TYPE_SET) {\n        model.setParamFloat(param.id, param.value, weight);\n      }\n    }\n  }\n}\n\n//============================================================\nL2DExpressionMotion.EXPRESSION_DEFAULT = 'DEFAULT';\nL2DExpressionMotion.TYPE_SET = 0;\nL2DExpressionMotion.TYPE_ADD = 1;\nL2DExpressionMotion.TYPE_MULT = 2;\n\n//============================================================\n//============================================================\n//  class L2DExpressionParam\n//============================================================\n//============================================================\nfunction L2DExpressionParam() {\n  this.id = '';\n  this.type = -1;\n  this.value = null;\n}\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DEyeBlink\n//============================================================\n//============================================================\nclass L2DEyeBlink {\n  constructor() {\n    this.nextBlinkTime = null /* TODO NOT INIT */; //\n    this.stateStartTime = null /* TODO NOT INIT */; //\n    this.blinkIntervalMsec = null /* TODO NOT INIT */; //\n    this.eyeState = EYE_STATE.STATE_FIRST;\n    this.blinkIntervalMsec = 4000;\n    this.closingMotionMsec = 100;\n    this.closedMotionMsec = 50;\n    this.openingMotionMsec = 150;\n    this.closeIfZero = true;\n    this.eyeID_L = 'PARAM_EYE_L_OPEN';\n    this.eyeID_R = 'PARAM_EYE_R_OPEN';\n  }\n\n  //============================================================\n  //    L2DEyeBlink # calcNextBlink()\n  //============================================================\n  calcNextBlink() {\n    const time /*long*/ = UtSystem.getUserTimeMSec();\n    const r /*Number*/ = Math.random();\n    return /*(long)*/ time + r * (2 * this.blinkIntervalMsec - 1);\n  }\n\n  //============================================================\n  //    L2DEyeBlink # setInterval()\n  //============================================================\n  setInterval(blinkIntervalMsec /*int*/) {\n    this.blinkIntervalMsec = blinkIntervalMsec;\n  }\n\n  //============================================================\n  //    L2DEyeBlink # setEyeMotion()\n  //============================================================\n  setEyeMotion(\n    closingMotionMsec /*int*/,\n    closedMotionMsec /*int*/,\n    openingMotionMsec /*int*/,\n  ) {\n    this.closingMotionMsec = closingMotionMsec;\n    this.closedMotionMsec = closedMotionMsec;\n    this.openingMotionMsec = openingMotionMsec;\n  }\n\n  //============================================================\n  //    L2DEyeBlink # updateParam()\n  //============================================================\n  updateParam(model /*ALive2DModel*/) {\n    const time /*:long*/ = UtSystem.getUserTimeMSec();\n    let eyeParamValue /*:Number*/;\n    let t /*:Number*/ = 0;\n    switch (this.eyeState) {\n    case EYE_STATE.STATE_CLOSING:\n      t = (time - this.stateStartTime) / this.closingMotionMsec;\n      if (t >= 1) {\n        t = 1;\n        this.eyeState = EYE_STATE.STATE_CLOSED;\n        this.stateStartTime = time;\n      }\n      eyeParamValue = 1 - t;\n      break;\n    case EYE_STATE.STATE_CLOSED:\n      t = (time - this.stateStartTime) / this.closedMotionMsec;\n      if (t >= 1) {\n        this.eyeState = EYE_STATE.STATE_OPENING;\n        this.stateStartTime = time;\n      }\n      eyeParamValue = 0;\n      break;\n    case EYE_STATE.STATE_OPENING:\n      t = (time - this.stateStartTime) / this.openingMotionMsec;\n      if (t >= 1) {\n        t = 1;\n        this.eyeState = EYE_STATE.STATE_INTERVAL;\n        this.nextBlinkTime = this.calcNextBlink();\n      }\n      eyeParamValue = t;\n      break;\n    case EYE_STATE.STATE_INTERVAL:\n      if (this.nextBlinkTime < time) {\n        this.eyeState = EYE_STATE.STATE_CLOSING;\n        this.stateStartTime = time;\n      }\n      eyeParamValue = 1;\n      break;\n    case EYE_STATE.STATE_FIRST:\n    default:\n      this.eyeState = EYE_STATE.STATE_INTERVAL;\n      this.nextBlinkTime = this.calcNextBlink();\n      eyeParamValue = 1;\n      break;\n    }\n    if (!this.closeIfZero) eyeParamValue = -eyeParamValue;\n    model.setParamFloat(this.eyeID_L, eyeParamValue);\n    model.setParamFloat(this.eyeID_R, eyeParamValue);\n  }\n}\n\n//== enum EYE_STATE ==\nconst EYE_STATE = () => { };\n\nEYE_STATE.STATE_FIRST = 'STATE_FIRST';\nEYE_STATE.STATE_INTERVAL = 'STATE_INTERVAL';\nEYE_STATE.STATE_CLOSING = 'STATE_CLOSING';\nEYE_STATE.STATE_CLOSED = 'STATE_CLOSED';\nEYE_STATE.STATE_OPENING = 'STATE_OPENING';\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DMatrix44\n//============================================================\n//============================================================\nclass L2DMatrix44 {\n  constructor() {\n    this.tr = new Float32Array(16); //\n    this.identity();\n  }\n\n  //============================================================\n  //    static L2DMatrix44.mul()\n  //============================================================\n  static mul(a /*float[]*/, b /*float[]*/, dst /*float[]*/) {\n    const c = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n    const n = 4;\n    let i, j, k;\n    for (i = 0; i < n; i++) {\n      for (j = 0; j < n; j++) {\n        for (k = 0; k < n; k++) {\n          c[i + j * 4] += a[i + k * 4] * b[k + j * 4];\n        }\n      }\n    }\n    for (i = 0; i < 16; i++) {\n      dst[i] = c[i];\n    }\n  }\n\n  //============================================================\n  //    L2DMatrix44 # identity()\n  //============================================================\n  identity() {\n    for (let i /*:int*/ = 0; i < 16; i++) this.tr[i] = i % 5 == 0 ? 1 : 0;\n  }\n\n  //============================================================\n  //    L2DMatrix44 # getArray()\n  //============================================================\n  getArray() {\n    return this.tr;\n  }\n\n  //============================================================\n  //    L2DMatrix44 # getCopyMatrix()\n  //============================================================\n  getCopyMatrix() {\n    return new Float32Array(this.tr); // this.tr.clone();\n  }\n\n  //============================================================\n  //    L2DMatrix44 # setMatrix()\n  //============================================================\n  setMatrix(tr /*float[]*/) {\n    if (this.tr == null || this.tr.length != this.tr.length) return;\n    for (let i /*:int*/ = 0; i < 16; i++) this.tr[i] = tr[i];\n  }\n\n  //============================================================\n  //    L2DMatrix44 # getScaleX()\n  //============================================================\n  getScaleX() {\n    return this.tr[0];\n  }\n\n  //============================================================\n  //    L2DMatrix44 # getScaleY()\n  //============================================================\n  getScaleY() {\n    return this.tr[5];\n  }\n\n  //============================================================\n  //    L2DMatrix44 # transformX()\n  //============================================================\n  transformX(src /*float*/) {\n    return this.tr[0] * src + this.tr[12];\n  }\n\n  //============================================================\n  //    L2DMatrix44 # transformY()\n  //============================================================\n  transformY(src /*float*/) {\n    return this.tr[5] * src + this.tr[13];\n  }\n\n  //============================================================\n  //    L2DMatrix44 # invertTransformX()\n  //============================================================\n  invertTransformX(src /*float*/) {\n    return (src - this.tr[12]) / this.tr[0];\n  }\n\n  //============================================================\n  //    L2DMatrix44 # invertTransformY()\n  //============================================================\n  invertTransformY(src /*float*/) {\n    return (src - this.tr[13]) / this.tr[5];\n  }\n\n  //============================================================\n  //    L2DMatrix44 # multTranslate()\n  //============================================================\n  multTranslate(shiftX /*float*/, shiftY /*float*/) {\n    const tr1 = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, shiftX, shiftY, 0, 1];\n    L2DMatrix44.mul(tr1, this.tr, this.tr);\n  }\n\n  //============================================================\n  //    L2DMatrix44 # translate()\n  //============================================================\n  translate(x /*float*/, y /*float*/) {\n    this.tr[12] = x;\n    this.tr[13] = y;\n  }\n\n  //============================================================\n  //    L2DMatrix44 # translateX()\n  //============================================================\n  translateX(x /*float*/) {\n    this.tr[12] = x;\n  }\n\n  //============================================================\n  //    L2DMatrix44 # translateY()\n  //============================================================\n  translateY(y /*float*/) {\n    this.tr[13] = y;\n  }\n\n  //============================================================\n  //    L2DMatrix44 # multScale()\n  //============================================================\n  multScale(scaleX /*float*/, scaleY /*float*/) {\n    const tr1 = [scaleX, 0, 0, 0, 0, scaleY, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];\n    L2DMatrix44.mul(tr1, this.tr, this.tr);\n  }\n\n  //============================================================\n  //    L2DMatrix44 # scale()\n  //============================================================\n  scale(scaleX /*float*/, scaleY /*float*/) {\n    this.tr[0] = scaleX;\n    this.tr[5] = scaleY;\n  }\n}\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DModelMatrix       extends     L2DMatrix44\n//============================================================\n//============================================================\nclass L2DModelMatrix extends L2DMatrix44 {\n  constructor(w /*float*/, h /*float*/) {\n    super();\n    this.width = w;\n    this.height = h;\n  }\n\n  //============================================================\n  //    L2DModelMatrix # setPosition()\n  //============================================================\n  setPosition(x /*float*/, y /*float*/) {\n    this.translate(x, y);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # setCenterPosition()\n  //============================================================\n  setCenterPosition(x /*float*/, y /*float*/) {\n    const w = this.width * this.getScaleX();\n    const h = this.height * this.getScaleY();\n    this.translate(x - w / 2, y - h / 2);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # top()\n  //============================================================\n  top(y /*float*/) {\n    this.setY(y);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # bottom()\n  //============================================================\n  bottom(y /*float*/) {\n    const h = this.height * this.getScaleY();\n    this.translateY(y - h);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # left()\n  //============================================================\n  left(x /*float*/) {\n    this.setX(x);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # right()\n  //============================================================\n  right(x /*float*/) {\n    const w = this.width * this.getScaleX();\n    this.translateX(x - w);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # centerX()\n  //============================================================\n  centerX(x /*float*/) {\n    const w = this.width * this.getScaleX();\n    this.translateX(x - w / 2);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # centerY()\n  //============================================================\n  centerY(y /*float*/) {\n    const h = this.height * this.getScaleY();\n    this.translateY(y - h / 2);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # setX()\n  //============================================================\n  setX(x /*float*/) {\n    this.translateX(x);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # setY()\n  //============================================================\n  setY(y /*float*/) {\n    this.translateY(y);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # setHeight()\n  //============================================================\n  setHeight(h /*float*/) {\n    const scaleX = h / this.height;\n    const scaleY = -scaleX;\n    this.scale(scaleX, scaleY);\n  }\n\n  //============================================================\n  //    L2DModelMatrix # setWidth()\n  //============================================================\n  setWidth(w /*float*/) {\n    const scaleX = w / this.width;\n    const scaleY = -scaleX;\n    this.scale(scaleX, scaleY);\n  }\n}\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DMotionManager     extends     MotionQueueManager\n//============================================================\n//============================================================\nclass L2DMotionManager extends MotionQueueManager {\n  constructor() {\n    super();\n    this.currentPriority = null;\n    this.reservePriority = null;\n\n    this.super = MotionQueueManager.prototype;\n  }\n\n  //============================================================\n  //    L2DMotionManager # getCurrentPriority()\n  //============================================================\n  getCurrentPriority() {\n    return this.currentPriority;\n  }\n\n  //============================================================\n  //    L2DMotionManager # getReservePriority()\n  //============================================================\n  getReservePriority() {\n    return this.reservePriority;\n  }\n\n  //============================================================\n  //    L2DMotionManager # reserveMotion()\n  //============================================================\n  reserveMotion(priority /*int*/) {\n    if (this.reservePriority >= priority) {\n      return false;\n    }\n    if (this.currentPriority >= priority) {\n      return false;\n    }\n\n    this.reservePriority = priority;\n\n    return true;\n  }\n\n  //============================================================\n  //    L2DMotionManager # setReservePriority()\n  //============================================================\n  setReservePriority(val /*int*/) {\n    this.reservePriority = val;\n  }\n\n  //============================================================\n  //    L2DMotionManager # updateParam()\n  //============================================================\n  updateParam(model /*ALive2DModel*/) {\n    const updated = MotionQueueManager.prototype.updateParam.call(this, model);\n\n    if (this.isFinished()) {\n      this.currentPriority = 0;\n    }\n\n    return updated;\n  }\n\n  //============================================================\n  //    L2DMotionManager # startMotionPrio()\n  //============================================================\n  startMotionPrio(motion /*AMotion*/, priority /*int*/) {\n    if (priority == this.reservePriority) {\n      this.reservePriority = 0;\n    }\n    this.currentPriority = priority;\n    return this.startMotion(motion, false);\n  }\n}\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DPhysics\n//============================================================\n//============================================================\nclass L2DPhysics {\n  constructor() {\n    this.physicsList = []; //ArrayList<PhysicsHair>\n    this.startTimeMSec = UtSystem.getUserTimeMSec();\n  }\n\n  //============================================================\n  //    static L2DPhysics.load()\n  //============================================================\n  static load(buf /*byte[]*/) {\n    const ret = new L2DPhysics(); //L2DPhysicsL2DPhysics\n    const pm = Live2DFramework.getPlatformManager();\n    const json = pm.jsonParseFromBytes(buf);\n    const params = json.physics_hair;\n    const paramNum = params.length;\n    for (let i = 0; i < paramNum; i++) {\n      const param = params[i]; //Value\n      const physics = new PhysicsHair(); //PhysicsHairPhysicsHair\n      const setup = param.setup; //Value\n      const length = parseFloat(setup.length);\n      const resist = parseFloat(setup.regist);\n      const mass = parseFloat(setup.mass);\n      physics.setup(length, resist, mass);\n      const srcList = param.src; //Value\n      const srcNum = srcList.length;\n      for (let j = 0; j < srcNum; j++) {\n        const src = srcList[j]; //Value\n        let id = src.id; //String\n        let type = PhysicsHair.Src.SRC_TO_X;\n        let typeStr = src.ptype; //String\n        if (typeStr === 'x') {\n          type = PhysicsHair.Src.SRC_TO_X;\n        } else if (typeStr === 'y') {\n          type = PhysicsHair.Src.SRC_TO_Y;\n        } else if (typeStr === 'angle') {\n          type = PhysicsHair.Src.SRC_TO_G_ANGLE;\n        } else {\n          UtDebug.error('live2d', 'Invalid parameter:PhysicsHair.Src');\n        }\n        let scale = parseFloat(src.scale);\n        let weight = parseFloat(src.weight);\n        physics.addSrcParam(type, id, scale, weight);\n      }\n      const targetList = param.targets; //Value\n      const targetNum = targetList.length;\n      for (let j = 0; j < targetNum; j++) {\n        const target = targetList[j]; //Value\n        let id = target.id; //String\n        let type = PhysicsHair.Target.TARGET_FROM_ANGLE;\n        let typeStr = target.ptype; //String\n        if (typeStr === 'angle') {\n          type = PhysicsHair.Target.TARGET_FROM_ANGLE;\n        } else if (typeStr === 'angle_v') {\n          type = PhysicsHair.Target.TARGET_FROM_ANGLE_V;\n        } else {\n          UtDebug.error('live2d', 'Invalid parameter:PhysicsHair.Target');\n        }\n        let scale = parseFloat(target.scale);\n        let weight = parseFloat(target.weight);\n        physics.addTargetParam(type, id, scale, weight);\n      }\n      ret.physicsList.push(physics);\n    }\n    return ret;\n  }\n\n  //============================================================\n  //    L2DPhysics # updateParam()\n  //============================================================\n  updateParam(model /*ALive2DModel*/) {\n    const timeMSec = UtSystem.getUserTimeMSec() - this.startTimeMSec;\n    for (let i = 0; i < this.physicsList.length; i++) {\n      this.physicsList[i].update(model, timeMSec);\n    }\n  }\n}\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DPose\n//============================================================\n//============================================================\nclass L2DPose {\n  constructor() {\n    this.lastTime = 0;\n    this.lastModel = null; //ALive2DModel\n    this.partsGroups = []; //ArrayList<L2DPartsParam[]>\n  }\n\n  //============================================================\n  //    static L2DPose.load()\n  //============================================================\n  static load(buf /*byte[]*/) {\n    const ret = new L2DPose(); //L2DPose\n    const pm = Live2DFramework.getPlatformManager();\n    const json = pm.jsonParseFromBytes(buf);\n    const poseListInfo = json.parts_visible; //Value\n    const poseNum = poseListInfo.length;\n    for (let i_pose = 0; i_pose < poseNum; i_pose++) {\n      const poseInfo = poseListInfo[i_pose]; //Value\n      const idListInfo = poseInfo.group; //Value\n      const idNum = idListInfo.length;\n      const partsGroup /*L2DPartsParam*/ = [];\n      for (let i_group = 0; i_group < idNum; i_group++) {\n        const partsInfo = idListInfo[i_group]; //Value\n        const parts = new L2DPartsParam(partsInfo.id); //L2DPartsParamL2DPartsParam\n        partsGroup[i_group] = parts;\n        if (partsInfo.link == null) continue;\n        const linkListInfo = partsInfo.link; //Value\n        const linkNum = linkListInfo.length;\n        parts.link = []; //ArrayList<L2DPartsParam>\n        for (let i_link = 0; i_link < linkNum; i_link++) {\n          const linkParts = new L2DPartsParam(linkListInfo[i_link]); //L2DPartsParamL2DPartsParam\n          parts.link.push(linkParts);\n        }\n      }\n      ret.partsGroups.push(partsGroup);\n    }\n\n    return ret;\n  }\n\n  //============================================================\n  //    L2DPose # updateParam()\n  //============================================================\n  updateParam(model /*ALive2DModel*/) {\n    if (model == null) return;\n\n    if (!(model == this.lastModel)) {\n      this.initParam(model);\n    }\n    this.lastModel = model;\n\n    const curTime = UtSystem.getUserTimeMSec();\n    let deltaTimeSec =\n      this.lastTime == 0 ? 0 : (curTime - this.lastTime) / 1000.0;\n    this.lastTime = curTime;\n    if (deltaTimeSec < 0) deltaTimeSec = 0;\n    for (let i = 0; i < this.partsGroups.length; i++) {\n      this.normalizePartsOpacityGroup(model, this.partsGroups[i], deltaTimeSec);\n      this.copyOpacityOtherParts(model, this.partsGroups[i]);\n    }\n  }\n\n  //============================================================\n  //    L2DPose # initParam()\n  //============================================================\n  initParam(model /*ALive2DModel*/) {\n    if (model == null) return;\n    for (let i = 0; i < this.partsGroups.length; i++) {\n      const partsGroup = this.partsGroups[i]; //L2DPartsParam\n      for (let j = 0; j < partsGroup.length; j++) {\n        partsGroup[j].initIndex(model);\n        const partsIndex = partsGroup[j].partsIndex;\n        const paramIndex = partsGroup[j].paramIndex;\n        if (partsIndex < 0) continue;\n        const v /*:Boolean*/ = model.getParamFloat(paramIndex) != 0;\n        model.setPartsOpacity(partsIndex, v ? 1.0 : 0.0);\n        model.setParamFloat(paramIndex, v ? 1.0 : 0.0);\n        if (partsGroup[j].link == null) continue;\n        for (let k = 0; k < partsGroup[j].link.length; k++) {\n          partsGroup[j].link[k].initIndex(model);\n        }\n      }\n    }\n  }\n\n  //============================================================\n  //    L2DPose # normalizePartsOpacityGroup()\n  //============================================================\n  normalizePartsOpacityGroup(\n    model /*ALive2DModel*/,\n    partsGroup /*L2DPartsParam[]*/,\n    deltaTimeSec /*float*/,\n  ) {\n    let visibleParts = -1;\n    let visibleOpacity = 1.0;\n    const CLEAR_TIME_SEC = 0.5;\n    const phi = 0.5;\n    const maxBackOpacity = 0.15;\n    for (let i = 0; i < partsGroup.length; i++) {\n      let partsIndex = partsGroup[i].partsIndex;\n      const paramIndex = partsGroup[i].paramIndex;\n      if (partsIndex < 0) continue;\n      if (model.getParamFloat(paramIndex) != 0) {\n        if (visibleParts >= 0) {\n          break;\n        }\n        visibleParts = i;\n        visibleOpacity = model.getPartsOpacity(partsIndex);\n        visibleOpacity += deltaTimeSec / CLEAR_TIME_SEC;\n        if (visibleOpacity > 1) {\n          visibleOpacity = 1;\n        }\n      }\n    }\n    if (visibleParts < 0) {\n      visibleParts = 0;\n      visibleOpacity = 1;\n    }\n    for (let i = 0; i < partsGroup.length; i++) {\n      let partsIndex = partsGroup[i].partsIndex;\n      if (partsIndex < 0) continue;\n      if (visibleParts == i) {\n        model.setPartsOpacity(partsIndex, visibleOpacity);\n      } else {\n        let opacity = model.getPartsOpacity(partsIndex);\n        let a1;\n        if (visibleOpacity < phi) {\n          a1 = (visibleOpacity * (phi - 1)) / phi + 1;\n        } else {\n          a1 = ((1 - visibleOpacity) * phi) / (1 - phi);\n        }\n        const backOp = (1 - a1) * (1 - visibleOpacity);\n        if (backOp > maxBackOpacity) {\n          a1 = 1 - maxBackOpacity / (1 - visibleOpacity);\n        }\n        if (opacity > a1) {\n          opacity = a1;\n        }\n        model.setPartsOpacity(partsIndex, opacity);\n      }\n    }\n  }\n\n  //============================================================\n  //    L2DPose # copyOpacityOtherParts()\n  //============================================================\n  copyOpacityOtherParts(\n    model /*ALive2DModel*/,\n    partsGroup /*L2DPartsParam[]*/,\n  ) {\n    for (let i_group = 0; i_group < partsGroup.length; i_group++) {\n      const partsParam = partsGroup[i_group]; //L2DPartsParam\n      if (partsParam.link == null) continue;\n      if (partsParam.partsIndex < 0) continue;\n      const opacity = model.getPartsOpacity(partsParam.partsIndex);\n      for (let i_link = 0; i_link < partsParam.link.length; i_link++) {\n        const linkParts = partsParam.link[i_link]; //L2DPartsParam\n        if (linkParts.partsIndex < 0) continue;\n        model.setPartsOpacity(linkParts.partsIndex, opacity);\n      }\n    }\n  }\n}\n\n//============================================================\n//============================================================\n//  class L2DPartsParam\n//============================================================\n//============================================================\nclass L2DPartsParam {\n  constructor(id /*String*/) {\n    this.paramIndex = -1;\n    this.partsIndex = -1;\n    this.link = null; // ArrayList<L2DPartsParam>\n    this.id = id;\n  }\n\n  //============================================================\n  //    L2DPartsParam # initIndex()\n  //============================================================\n  initIndex(model /*ALive2DModel*/) {\n    this.paramIndex = model.getParamIndex('VISIBLE:' + this.id);\n    this.partsIndex = model.getPartsDataIndex(PartsDataID.getID(this.id));\n    model.setParamFloat(this.paramIndex, 1);\n  }\n}\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DTargetPoint\n//============================================================\n//============================================================\nclass L2DTargetPoint {\n  constructor() {\n    this.EPSILON = 0.01; // 変化の最小値（この値以下は無視される）\n    this.faceTargetX = 0;\n    this.faceTargetY = 0;\n    this.faceX = 0;\n    this.faceY = 0;\n    this.faceVX = 0;\n    this.faceVY = 0;\n    this.lastTimeSec = 0;\n  }\n\n  //============================================================\n  //    L2DTargetPoint # set()\n  //============================================================\n  setPoint(x /*float*/, y /*float*/) {\n    this.faceTargetX = x;\n    this.faceTargetY = y;\n  }\n\n  //============================================================\n  //    L2DTargetPoint # getX()\n  //============================================================\n  getX() {\n    return this.faceX;\n  }\n\n  //============================================================\n  //    L2DTargetPoint # getY()\n  //============================================================\n  getY() {\n    return this.faceY;\n  }\n\n  //============================================================\n  //    L2DTargetPoint # update()\n  //============================================================\n  update() {\n    const TIME_TO_MAX_SPEED = 0.15;\n    const FACE_PARAM_MAX_V = 40.0 / 7.5;\n    const MAX_V = FACE_PARAM_MAX_V / L2DTargetPoint.FRAME_RATE;\n    if (this.lastTimeSec == 0) {\n      this.lastTimeSec = UtSystem.getUserTimeMSec();\n      return;\n    }\n    const curTimeSec = UtSystem.getUserTimeMSec();\n    const deltaTimeWeight =\n      ((curTimeSec - this.lastTimeSec) * L2DTargetPoint.FRAME_RATE) / 1000.0;\n    this.lastTimeSec = curTimeSec;\n    const FRAME_TO_MAX_SPEED = TIME_TO_MAX_SPEED * L2DTargetPoint.FRAME_RATE;\n    const MAX_A = (deltaTimeWeight * MAX_V) / FRAME_TO_MAX_SPEED;\n    const dx = this.faceTargetX - this.faceX;\n    const dy = this.faceTargetY - this.faceY;\n    // if(dx == 0 && dy == 0) return;\n    if (Math.abs(dx) <= this.EPSILON && Math.abs(dy) <= this.EPSILON) return;\n    const d = Math.sqrt(dx * dx + dy * dy);\n    const vx = (MAX_V * dx) / d;\n    const vy = (MAX_V * dy) / d;\n    let ax = vx - this.faceVX;\n    let ay = vy - this.faceVY;\n    let a = Math.sqrt(ax * ax + ay * ay);\n    if (a < -MAX_A || a > MAX_A) {\n      ax *= MAX_A / a;\n      ay *= MAX_A / a;\n      a = MAX_A;\n    }\n    this.faceVX += ax;\n    this.faceVY += ay;\n    {\n      const max_v =\n        0.5 *\n        (Math.sqrt(MAX_A * MAX_A + 16 * MAX_A * d - 8 * MAX_A * d) - MAX_A);\n      const cur_v = Math.sqrt(\n        this.faceVX * this.faceVX + this.faceVY * this.faceVY,\n      );\n      if (cur_v > max_v) {\n        this.faceVX *= max_v / cur_v;\n        this.faceVY *= max_v / cur_v;\n      }\n    }\n    this.faceX += this.faceVX;\n    this.faceY += this.faceVY;\n  }\n}\n\n//============================================================\nL2DTargetPoint.FRAME_RATE = 30;\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class L2DViewMatrix        extends     L2DMatrix44\n//============================================================\n//============================================================\nclass L2DViewMatrix extends L2DMatrix44 {\n  constructor() {\n    super();\n    this.screenLeft = null;\n    this.screenRight = null;\n    this.screenTop = null;\n    this.screenBottom = null;\n    this.maxLeft = null;\n    this.maxRight = null;\n    this.maxTop = null;\n    this.maxBottom = null;\n    this.max = Number.MAX_VALUE;\n    this.min = 0;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getMaxScale()\n  //============================================================\n  getMaxScale() {\n    return this.max;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getMinScale()\n  //============================================================\n  getMinScale() {\n    return this.min;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # setMaxScale()\n  //============================================================\n  setMaxScale(v /*float*/) {\n    this.max = v;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # setMinScale()\n  //============================================================\n  setMinScale(v /*float*/) {\n    this.min = v;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # isMaxScale()\n  //============================================================\n  isMaxScale() {\n    return this.getScaleX() == this.max;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # isMinScale()\n  //============================================================\n  isMinScale() {\n    return this.getScaleX() == this.min;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # adjustTranslate()\n  //============================================================\n  adjustTranslate(shiftX /*float*/, shiftY /*float*/) {\n    if (this.tr[0] * this.maxLeft + (this.tr[12] + shiftX) > this.screenLeft)\n      shiftX = this.screenLeft - this.tr[0] * this.maxLeft - this.tr[12];\n    if (this.tr[0] * this.maxRight + (this.tr[12] + shiftX) < this.screenRight)\n      shiftX = this.screenRight - this.tr[0] * this.maxRight - this.tr[12];\n    if (this.tr[5] * this.maxTop + (this.tr[13] + shiftY) < this.screenTop)\n      shiftY = this.screenTop - this.tr[5] * this.maxTop - this.tr[13];\n    if (\n      this.tr[5] * this.maxBottom + (this.tr[13] + shiftY) >\n      this.screenBottom\n    )\n      shiftY = this.screenBottom - this.tr[5] * this.maxBottom - this.tr[13];\n\n    const tr1 = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, shiftX, shiftY, 0, 1];\n    L2DMatrix44.mul(tr1, this.tr, this.tr);\n  }\n\n  //============================================================\n  //    L2DViewMatrix # adjustScale()\n  //============================================================\n  adjustScale(cx /*float*/, cy /*float*/, scale /*float*/) {\n    const targetScale = scale * this.tr[0];\n    if (targetScale < this.min) {\n      if (this.tr[0] > 0) scale = this.min / this.tr[0];\n    } else if (targetScale > this.max) {\n      if (this.tr[0] > 0) scale = this.max / this.tr[0];\n    }\n    const tr1 = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, cx, cy, 0, 1];\n    const tr2 = [scale, 0, 0, 0, 0, scale, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];\n    const tr3 = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, -cx, -cy, 0, 1];\n    L2DMatrix44.mul(tr3, this.tr, this.tr);\n    L2DMatrix44.mul(tr2, this.tr, this.tr);\n    L2DMatrix44.mul(tr1, this.tr, this.tr);\n  }\n\n  //============================================================\n  //    L2DViewMatrix # setScreenRect()\n  //============================================================\n  setScreenRect(\n    left /*float*/,\n    right /*float*/,\n    bottom /*float*/,\n    top /*float*/,\n  ) {\n    this.screenLeft = left;\n    this.screenRight = right;\n    this.screenTop = top;\n    this.screenBottom = bottom;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # setMaxScreenRect()\n  //============================================================\n  setMaxScreenRect(\n    left /*float*/,\n    right /*float*/,\n    bottom /*float*/,\n    top /*float*/,\n  ) {\n    this.maxLeft = left;\n    this.maxRight = right;\n    this.maxTop = top;\n    this.maxBottom = bottom;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getScreenLeft()\n  //============================================================\n  getScreenLeft() {\n    return this.screenLeft;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getScreenRight()\n  //============================================================\n  getScreenRight() {\n    return this.screenRight;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getScreenBottom()\n  //============================================================\n  getScreenBottom() {\n    return this.screenBottom;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getScreenTop()\n  //============================================================\n  getScreenTop() {\n    return this.screenTop;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getMaxLeft()\n  //============================================================\n  getMaxLeft() {\n    return this.maxLeft;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getMaxRight()\n  //============================================================\n  getMaxRight() {\n    return this.maxRight;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getMaxBottom()\n  //============================================================\n  getMaxBottom() {\n    return this.maxBottom;\n  }\n\n  //============================================================\n  //    L2DViewMatrix # getMaxTop()\n  //============================================================\n  getMaxTop() {\n    return this.maxTop;\n  }\n}\n\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\n//============================================================\n//============================================================\n//  class Live2DFramework\n//============================================================\n//============================================================\nclass Live2DFramework {\n  //============================================================\n  //    static Live2DFramework.getPlatformManager()\n  //============================================================\n  static getPlatformManager() {\n    return Live2DFramework.platformManager;\n  }\n\n  //============================================================\n  //    static Live2DFramework.setPlatformManager()\n  //============================================================\n  static setPlatformManager(platformManager /*IPlatformManager*/) {\n    Live2DFramework.platformManager = platformManager;\n  }\n}\n\n//============================================================\nLive2DFramework.platformManager = null;\n\nexport {\n  L2DBaseModel,\n  L2DViewMatrix,\n  L2DEyeBlink,\n  Live2DFramework,\n  L2DMatrix44,\n  L2DTargetPoint\n}\n","count_time":{"symbolsCount":"26k","symbolsTime":"23 mins."},"toc":"","data":[]}