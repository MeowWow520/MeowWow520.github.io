{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"/* global Image, Live2DModelWebGL, document, fetch */ /** * * You can modify and use this source freely * only for the development of applic...","date":"2025-11-18T04:43:50.344Z","updated":"2025-11-18T04:43:50.344Z","comments":true,"path":"api/pages/live2d-widget/src/cubism2/PlatformManager.js","covers":null,"content":"/* global Image, Live2DModelWebGL, document, fetch */\n/**\n *\n *  You can modify and use this source freely\n *  only for the development of application related Live2D.\n *\n *  (c) Live2D Inc. All rights reserved.\n */\n\nimport logger from '../logger.js';\n//============================================================\n//============================================================\n//  class PlatformManager     extend IPlatformManager\n//============================================================\n//============================================================\nclass PlatformManager {\n  constructor() {\n    this.cache = {};\n  }\n  //============================================================\n  //    PlatformManager # loadBytes()\n  //============================================================\n  loadBytes(path /*String*/, callback) {\n    if (path in this.cache) {\n      return callback(this.cache[path]);\n    }\n    fetch(path)\n      .then(response => response.arrayBuffer())\n      .then(arrayBuffer => {\n        this.cache[path] = arrayBuffer;\n        callback(arrayBuffer);\n      });\n  }\n\n  //============================================================\n  //    PlatformManager # loadLive2DModel()\n  //============================================================\n  loadLive2DModel(path /*String*/, callback) {\n    let model = null;\n\n    // load moc\n    this.loadBytes(path, buf => {\n      model = Live2DModelWebGL.loadModel(buf);\n      callback(model);\n    });\n  }\n\n  //============================================================\n  //    PlatformManager # loadTexture()\n  //============================================================\n  loadTexture(model /*ALive2DModel*/, no /*int*/, path /*String*/, callback) {\n    // load textures\n    const loadedImage = new Image();\n    loadedImage.crossOrigin = 'anonymous';\n    loadedImage.src = path;\n\n    loadedImage.onload = () => {\n      // create texture\n      const canvas = document.getElementById('live2d');\n      const gl = canvas.getContext('webgl2', { premultipliedAlpha: true, preserveDrawingBuffer: true });\n      let texture = gl.createTexture();\n      if (!texture) {\n        logger.error('Failed to generate gl texture name.');\n        return -1;\n      }\n\n      if (model.isPremultipliedAlpha() == false) {\n        // 乗算済アルファテクスチャ以外の場合\n        gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 1);\n      }\n      gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, 1);\n      gl.activeTexture(gl.TEXTURE0);\n      gl.bindTexture(gl.TEXTURE_2D, texture);\n      gl.texImage2D(\n        gl.TEXTURE_2D,\n        0,\n        gl.RGBA,\n        gl.RGBA,\n        gl.UNSIGNED_BYTE,\n        loadedImage,\n      );\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n      gl.texParameteri(\n        gl.TEXTURE_2D,\n        gl.TEXTURE_MIN_FILTER,\n        gl.LINEAR_MIPMAP_NEAREST,\n      );\n      gl.generateMipmap(gl.TEXTURE_2D);\n\n      model.setTexture(no, texture);\n\n      // テクスチャオブジェクトを解放\n      texture = null;\n\n      if (typeof callback == 'function') callback();\n    };\n\n    loadedImage.onerror = () => {\n      logger.error('Failed to load image : ' + path);\n    };\n  }\n\n  //============================================================\n  //    PlatformManager # parseFromBytes(buf)\n\n  //============================================================\n  jsonParseFromBytes(buf) {\n    let jsonStr;\n\n    const bomCode = new Uint8Array(buf, 0, 3);\n    if (bomCode[0] == 239 && bomCode[1] == 187 && bomCode[2] == 191) {\n      jsonStr = String.fromCharCode.apply(null, new Uint8Array(buf, 3));\n    } else {\n      jsonStr = String.fromCharCode.apply(null, new Uint8Array(buf));\n    }\n\n    const jsonObj = JSON.parse(jsonStr);\n\n    return jsonObj;\n  }\n}\n\nexport default PlatformManager;\n","count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"toc":"","data":[]}